#!/usr/bin/env bash

umask 022
unalias -a

if [ $# -ne 2 ]
then
	echo "Please specify ebuild file and unpack, compile or all"
	exit 1
fi
 
if [ -e ebuild.conf ]
then
	source ebuild.conf
elif [ -e /etc/ebuild.conf ]
then
	source /etc/ebuild.conf
else
	echo "ebuild.conf not found. Exiting."
fi
 
if [ -z "$DISTDIR" ]
then
	if [ -d distfiles ]
	then
		DISTDIR=$(pwd)/distfiles
	else 	
		# set DISTDIR to /usr/src/distfiles if not already set
		DISTDIR=/usr/src/distfiles
	fi
fi
export DISTDIR
 
try() {
	$*
	[ $? -ne 0 ] && echo "Error running command: $*" && exit 1
}

src_clean() {
	[ -d ${WORKDIR} ] && rm -rf ${WORKDIR}; install -d ${WORKDIR}; cd ${WORKDIR}
}

src_unpack() {
	[ ! -e ${DISTDIR}/${A} ] && echo "${DISTDIR}/${A} does not exist.  Please download first." && exit 1
	try tar xf ${DISTDIR}/${A}
	echo "Unpacked ${DISTDIR}/${A}."
	[ ! -d $S ] && echo "Source directory $S specified in \$S does not exist. Exiting." && exit 1
}

src_compile() {
	cd $S; try make $MAKEOPTS 
}

src_configure() {
	cd $S; [ -e ./configure ] && try ./configure --prefix=/usr 
}

src_install() {
	cd $S; try make DESTDIR=$IMAGEDIR install
}

P="${1%.ebuild}"
export ORIGDIR=$(pwd)
export IMAGEDIR=${ORIGDIR}/temp/$P/image
export WORKDIR=${ORIGDIR}/temp/$P/work
S=$WORKDIR/$P

if [ -e "$1" ]
then
	source $1
else
	echo "Ebuild file $1 not found."
	exit 1
fi

case "${2}" in
	clean)
		src_clean
		;;
	unpack)
		src_clean
		src_unpack
		;;
	configure)
		src_clean
		src_unpack
		src_configure
		;;
	compile)
		src_clean
		src_unpack
		src_configure
		src_compile
		;;
	install|all)
		src_clean
		src_unpack
		src_configure
		src_compile
		src_install
		;;
	*)
		echo "Please specify unpack, configure, compile or all as the second arg"
		exit 1
		;;
esac
